@using EntityFrameworkDatabaseLibrary.Models
@using DataHandlerLibrary.Services
@inject IJSRuntime JSRuntime

<!-- Modal -->
<div class="modal fade show" id="posUserModal" tabindex="-1" style="display:block" aria-labelledby="posUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="posUserModalLabel">
                    @if (IsViewMode)
                    {
                        <i>View User</i>
                    }
                    else if (IsEditMode)
                    {
                        <i>Edit User</i>
                    }
                    else
                    {
                        <i>Create New User</i>
                    }
                </h5>
                <button type="button" class="btn-close" @onclick="CloseModal" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <EditForm Model="CurrentUser" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>@ErrorMessage
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i>@SuccessMessage
                        </div>
                    }

                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="fas fa-user me-2"></i>Basic Information</h6>
                            
                            <div class="mb-3">
                                <label for="firstName" class="form-label">First Name *</label>
                                <InputText id="firstName" class="form-control" @bind-Value="CurrentUser.First_Name" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.First_Name)" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="lastName" class="form-label">Last Name *</label>
                                <InputText id="lastName" class="form-control" @bind-Value="CurrentUser.Last_Name" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.Last_Name)" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="passcode" class="form-label">Passcode *</label>
                                <InputNumber id="passcode" class="form-control" @bind-Value="CurrentUser.Passcode" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.Passcode)" />
                                <div class="form-text">8-digit passcode for user authentication</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <InputCheckbox id="adminUser" class="form-check-input" @bind-Value="CurrentUser.Admin_User" disabled="@IsViewMode" />
                                    <label class="form-check-label" for="adminUser">
                                        Administrator User
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Role and Site Assignment -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="fas fa-building me-2"></i>Role & Site Assignment</h6>
                            
                            <div class="mb-3">
                                <label for="roleId" class="form-label">Role *</label>
                                <InputSelect id="roleId" class="form-select" @bind-Value="CurrentUser.Role_ID" disabled="@IsViewMode">
                                    <option value="0">-- Select Role --</option>
                                    @if (AvailableRoles != null)
                                    {
                                        @foreach (var role in AvailableRoles)
                                        {
                                            <option value="@role.Role_ID">@role.Role_Name</option>
                                        }
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => CurrentUser.Role_ID)" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="primarySiteId" class="form-label">Primary Site</label>
                                <InputSelect id="primarySiteId" class="form-select" @bind-Value="CurrentUser.Primary_Site_Id" disabled="@IsViewMode">
                                    <option value="">-- No Primary Site --</option>
                                    @if (AvailableSites != null)
                                    {
                                        @foreach (var site in AvailableSites)
                                        {
                                            <option value="@site.Site_Id">@site.Site_BusinessName</option>
                                        }
                                    }
                                </InputSelect>
                                <div class="form-text">Primary site for staff locked to one location</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="tillId" class="form-label">Till ID</label>
                                <InputNumber id="tillId" class="form-control" @bind-Value="CurrentUser.Till_Id" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.Till_Id)" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Permissions -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-key me-2"></i>Permissions</h6>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedVoidLine" class="form-label">Allowed Void Line</label>
                                        <InputNumber id="allowedVoidLine" class="form-control" @bind-Value="CurrentUser.Allowed_Void_Line" disabled="@IsViewMode" />
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedVoidSale" class="form-label">Allowed Void Sale</label>
                                        <InputNumber id="allowedVoidSale" class="form-control" @bind-Value="CurrentUser.Allowed_Void_Sale" disabled="@IsViewMode" />
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedNoSale" class="form-label">Allowed No Sale</label>
                                        <InputNumber id="allowedNoSale" class="form-control" @bind-Value="CurrentUser.Allowed_No_Sale" disabled="@IsViewMode" />
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedReturns" class="form-label">Allowed Returns</label>
                                        <InputNumber id="allowedReturns" class="form-control" @bind-Value="CurrentUser.Allowed_Returns" disabled="@IsViewMode" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedPayout" class="form-label">Allowed Payout</label>
                                        <InputNumber id="allowedPayout" class="form-control" @bind-Value="CurrentUser.Allowed_Payout" disabled="@IsViewMode" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Information -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Status Information</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <InputCheckbox id="isActivated" class="form-check-input" @bind-Value="CurrentUser.Is_Activated" disabled="@IsViewMode" />
                                        <label class="form-check-label" for="isActivated">
                                            User is Activated
                                        </label>
                                    </div>
                                </div>
                                
                                @if (IsEditMode && CurrentUser.User_ID > 0)
                                {
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <InputCheckbox id="isDeleted" class="form-check-input" @bind-Value="CurrentUser.Is_Deleted" disabled="@IsViewMode" />
                                            <label class="form-check-label" for="isDeleted">
                                                Mark as Deleted
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            @if (IsEditMode && CurrentUser.User_ID > 0)
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Created:</strong> @CurrentUser.Date_Created.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Last Modified:</strong> @CurrentUser.Last_Modified.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" @onclick="CloseModal" data-bs-dismiss="modal">
                        @if (IsViewMode)
                        {
                            <i class="fas fa-times me-2">Close</i>
                        }
                        else
                        {
                            <i class="fas fa-times me-2">Cancel</i>
                        }
                    </button>

                    @if (!IsViewMode)
                    {
                        <button type="submit" class="btn btn-primary" disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            @if (IsEditMode)
                            {
                                <i class="fas fa-save me-2">Update User</i>
                            }
                            else
                            {
                                <i class="fas fa-plus me-2">Create User</i>
                            }
                        </button>
                    }
                   
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public PosUser CurrentUser { get; set; } = new();
    [Parameter] public List<UserRole> AvailableRoles { get; set; } = new();
    [Parameter] public List<Site> AvailableSites { get; set; } = new();
    [Parameter] public EventCallback<PosUser> OnUserSaved { get; set; }
    [Parameter] public EventCallback OnModalClosed { get; set; }
    [Parameter] public bool IsViewMode { get; set; } = false;
    [Parameter] public bool IsEditMode { get; set; } = false;

    private bool IsLoading = false;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;

    protected override void OnParametersSet()
    {
        // Clear messages when parameters change
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
    }

    private async Task HandleValidSubmit()
    {
        if (IsViewMode) return;

        IsLoading = true;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;

        try
        {
            // Set audit fields
            if (!IsEditMode)
            {
                CurrentUser.Date_Created = DateTime.Now;
                CurrentUser.Is_Activated = true;
                CurrentUser.Is_Deleted = false;
            }
            CurrentUser.Last_Modified = DateTime.Now;

            // Trigger the save event
            await OnUserSaved.InvokeAsync(CurrentUser);

            SuccessMessage = IsEditMode ? "User updated successfully!" : "User created successfully!";

            // Close modal after a short delay
            await Task.Delay(1500);
            await CloseModal();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error saving user: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    public async Task ShowModal()
    {
        await JSRuntime.InvokeVoidAsync("bootstrap.Modal.getOrCreateInstance", "#posUserModal").AsTask();
        await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('posUserModal')).show()");
    }

    public async Task CloseModal()
    {
        OnModalClosed.InvokeAsync();
    }
    
    public void SetCreateMode()
    {
        IsViewMode = false;
        IsEditMode = false;
        CurrentUser = new PosUser
        {
            Is_Activated = true,
            Is_Deleted = false,
            Date_Created = DateTime.Now,
            Last_Modified = DateTime.Now
        };
    }
    
    public void SetEditMode(PosUser user)
    {
        IsViewMode = false;
        IsEditMode = true;
        CurrentUser = new PosUser
        {
            User_ID = user.User_ID,
            Admin_User = user.Admin_User,
            First_Name = user.First_Name,
            Last_Name = user.Last_Name,
            Passcode = user.Passcode,
            Role_ID = user.Role_ID,
            Primary_Site_Id = user.Primary_Site_Id,
            Allowed_Void_Line = user.Allowed_Void_Line,
            Allowed_Void_Sale = user.Allowed_Void_Sale,
            Allowed_No_Sale = user.Allowed_No_Sale,
            Allowed_Returns = user.Allowed_Returns,
            Allowed_Payout = user.Allowed_Payout,
            Is_Activated = user.Is_Activated,
            Is_Deleted = user.Is_Deleted,
            Date_Created = user.Date_Created,
            Last_Modified = user.Last_Modified,
            Till_Id = user.Till_Id,
            Created_By_Id = user.Created_By_Id,
            Last_Modified_By_Id = user.Last_Modified_By_Id
        };
    }
    
    public void SetViewMode(PosUser user)
    {
        IsViewMode = true;
        IsEditMode = false;
        CurrentUser = user;
    }
}
