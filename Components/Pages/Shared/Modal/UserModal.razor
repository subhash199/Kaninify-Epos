@using EntityFrameworkDatabaseLibrary.Models
@using DataHandlerLibrary.Services
@inject UserManagementServices UserManagementServices
@inject IJSRuntime JSRuntime

<!-- Modal -->
<div class="modal fade show" id="posUserModal" tabindex="-1" style="display:block" aria-labelledby="posUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="posUserModalLabel">
                    @if (IsViewMode)
                    {
                        <span>View User</span>
                    }
                    else if (IsEditMode)
                    {
                        <span>Edit User</span>
                    }
                    else
                    {
                        <span>Create New User</span>
                    }
                </h5>
                <button type="button" class="btn-close" @onclick="CloseModal" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <EditForm Model="CurrentUser" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />

                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>@ErrorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i>@SuccessMessage
                        </div>
                    }

                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="fas fa-user me-2"></i>Basic Information</h6>

                            <div class="mb-3">
                                <label for="firstName" class="form-label">First Name *</label>
                                <InputText id="firstName" class="form-control" @bind-Value="CurrentUser.First_Name" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.First_Name)" />
                            </div>

                            <div class="mb-3">
                                <label for="lastName" class="form-label">Last Name *</label>
                                <InputText id="lastName" class="form-control" @bind-Value="CurrentUser.Last_Name" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.Last_Name)" />
                            </div>

                            <div class="mb-3">
                                <label for="passcode" class="form-label">Passcode *</label>
                                <InputNumber id="passcode" class="form-control" @bind-Value="CurrentUser.Passcode" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.Passcode)" />
                                <div class="form-text">8-digit passcode for user authentication</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <InputCheckbox id="adminUser" class="form-check-input" @bind-Value="CurrentUser.Admin_User" disabled="@IsViewMode" />
                                    <label class="form-check-label" for="adminUser">
                                        Administrator User
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Role and Site Assignment -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="fas fa-building me-2"></i>Role & Site Assignment</h6>

                            <div class="mb-3">
                                <label for="roleId" class="form-label">Role *</label>
                                <InputSelect id="roleId" class="form-select"
                                             @bind-Value="CurrentUser.Role_ID"
                                             @bind-Value:after="RoleChangedAsync"
                                             disabled="@IsViewMode">
                                    <option value="0">-- Select Role --</option>
                                    @if (AvailableRoles != null)
                                    {
                                        @foreach (var role in AvailableRoles)
                                        {
                                            <option value="@role.Role_ID">@role.Role_Name</option>
                                        }
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => CurrentUser.Role_ID)" />
                            </div>

                            <div class="mb-3">
                                <label for="primarySiteId" class="form-label">Primary Site</label>
                                <InputSelect id="primarySiteId" class="form-select" @bind-Value="CurrentUser.Primary_Site_Id" @bind-Value:after="PrimarySiteChangeAsync" disabled="@IsViewMode">
                                    <option value="">-- No Primary Site --</option>
                                    @if (AvailableSites != null)
                                    {
                                        @foreach (var site in AvailableSites)
                                        {
                                            <option value="@site.Site_Id">
                                                @($"{site.Site_BusinessName}{(string.IsNullOrWhiteSpace(site.Site_AddressLine1) ? "" : " " + site.Site_AddressLine1)}")
                                            </option>
                                        }
                                    }
                                </InputSelect>
                                <div class="form-text">Primary site for staff locked to one location</div>
                            </div>

                            <div class="mb-3">
                                <label for="tillId" class="form-label">Till ID</label>
                                <InputNumber id="tillId" class="form-control" @bind-Value="CurrentUser.Till_Id" disabled="@IsViewMode" />
                                <ValidationMessage For="@(() => CurrentUser.Till_Id)" />
                            </div>
                        </div>
                    </div>

                    <!-- Permissions -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-key me-2"></i>Permissions</h6>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedVoidLine" class="form-label">Allowed Void Line</label>
                                        <InputNumber id="allowedVoidLine" class="form-control" @bind-Value="CurrentUser.Allowed_Void_Line" disabled="@IsViewMode" />
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedVoidSale" class="form-label">Allowed Void Sale</label>
                                        <InputNumber id="allowedVoidSale" class="form-control" @bind-Value="CurrentUser.Allowed_Void_Sale" disabled="@IsViewMode" />
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedNoSale" class="form-label">Allowed No Sale</label>
                                        <InputNumber id="allowedNoSale" class="form-control" @bind-Value="CurrentUser.Allowed_No_Sale" disabled="@IsViewMode" />
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedReturns" class="form-label">Allowed Returns</label>
                                        <InputNumber id="allowedReturns" class="form-control" @bind-Value="CurrentUser.Allowed_Returns" disabled="@IsViewMode" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="allowedPayout" class="form-label">Allowed Payout</label>
                                        <InputNumber id="allowedPayout" class="form-control" @bind-Value="CurrentUser.Allowed_Payout" disabled="@IsViewMode" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Information -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Status Information</h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <InputCheckbox id="isActivated" class="form-check-input" @bind-Value="CurrentUser.Is_Activated" disabled="@IsViewMode" />
                                        <label class="form-check-label" for="isActivated">
                                            User is Activated
                                        </label>
                                    </div>
                                </div>

                                @if (IsEditMode && CurrentUser.User_ID > 0)
                                {
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <InputCheckbox id="isDeleted" class="form-check-input" @bind-Value="CurrentUser.Is_Deleted" disabled="@IsViewMode" />
                                            <label class="form-check-label" for="isDeleted">
                                                Mark as Deleted
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>

                            @if (IsEditMode && CurrentUser.User_ID > 0)
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Created:</strong> @CurrentUser.Date_Created.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Last Modified:</strong> @CurrentUser.Last_Modified.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" @onclick="CloseModal" data-bs-dismiss="modal">
                        @if (IsViewMode)
                        {
                            <span>Close</span>
                        }
                        else
                        {
                            <span>Cancel</span>
                        }
                    </button>

                    @if (!IsViewMode)
                    {
                        <button type="submit" class="btn btn-primary" disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            @if (IsEditMode)
                            {
                                <span class="fas fa-save me-2">Update User</span>
                            }
                            else
                            {
                                <span class="fas fa-plus me-2">Create User</span>
                            }
                        </button>
                    }

                </div>
            </EditForm>
        </div>
    </div>
</div>
@if (showSiteModal)
{
    <SiteModal IsVisible="showSiteModal"
               OnSiteSaved="OnSiteSaved"
               OnSiteDeleted="OnSiteDeleted"
               OncloseSiteModal="OncloseSiteModal">

    </SiteModal>
}

@if (showRoleModal)
{
    <UserRoleModal IsVisible=showRoleModal
                   OnUserRoleSaved="OnRoleSaved"
                   OnUserRoleDeleted="OnRoleDeleted"
                   OnCloseRoleModal="OnCloseRoleModal">
    </UserRoleModal>

}

@code {
    [Parameter] public PosUser CurrentUser { get; set; } = new();
    [Parameter] public List<UserRole> AvailableRoles { get; set; } = new();
    [Parameter] public List<Site> AvailableSites { get; set; } = new();
    [Parameter] public EventCallback<PosUser> OnUserSaved { get; set; }
    [Parameter] public EventCallback OnModalClosed { get; set; }
    [Parameter] public bool IsViewMode { get; set; } = false;
    [Parameter] public bool IsEditMode { get; set; } = false;

    private bool IsLoading = false;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;

    //Site Modal Reference
    private bool showSiteModal = false;

    //Role Modal Reference
    private bool showRoleModal = false;

    protected override void OnParametersSet()
    {
        // Clear messages when parameters change
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        // Add option for creating new site if not in view mode
        if (!IsViewMode)
        {
            if (!AvailableRoles.Exists(r => r.Role_ID == -1))
            {
                AvailableRoles.Add(new UserRole { Role_ID = -1, Role_Name = "-- Create New Role --" });
            }
            if (!AvailableSites.Exists(s => s.Site_Id == -1))
            {
                AvailableSites.Add(new Site { Site_Id = -1, Site_BusinessName = "-- Create New Site --", Site_AddressLine1 = "" });
            }
            StateHasChanged();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {

        }
    }
    private async Task RoleChangedAsync()
    {

        if (CurrentUser.Role_ID == -1) // Assuming 0 is the ID for creating a new site
        {
            showRoleModal = true;
            StateHasChanged(); // Refresh the component to show the site modal
        }
        // Logic to handle site change can be added here
        // e.g., fetching site-specific data or updating UI elements
    }


    private async Task RoleChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int roleId))
        {
            CurrentUser.Role_ID = roleId;

            if (roleId == 0)
            {
                showRoleModal = true;
                StateHasChanged();
            }

            // Add any additional role-specific logic here
            Console.WriteLine($"Role changed to: {roleId}");
        }
    }

    private async Task OnRoleSaved(UserRole role)
    {
        // Logic to handle role saved event
        // For example, you might want to refresh the list of available roles
        if (role != null)
        {
            // Add the new role to the available roles list
            AvailableRoles.Add(role);
            CurrentUser.Role_ID = role.Role_ID; // Set the role ID
        }
        showRoleModal = false; // Close the role modal after saving
    }

    private async Task OnRoleDeleted()
    {
        AvailableRoles = (await UserManagementServices.GetAllRolesAsync()).ToList(); // Refresh roles after deletion
        CurrentUser.Role_ID = 0; // Reset role if it was deleted
        showRoleModal = false; // Close the role modal after deletion
    }

    private async Task OnCloseRoleModal()
    {
        showRoleModal = false;
    }

    private async Task OncloseSiteModal()
    {
        showSiteModal = false;
    }

    private async Task PrimarySiteChangeAsync()
    {
        var selectedSiteId = CurrentUser.Primary_Site_Id?.ToString();
        if (!string.IsNullOrEmpty(selectedSiteId))
        {
            if (selectedSiteId == "0") // Assuming 0 is the ID for creating a new site
            {
                showSiteModal = true;
                StateHasChanged(); // Refresh the component to show the site modal
            }
            // Logic to handle site change can be added here
            // e.g., fetching site-specific data or updating UI elements
        }
    }

    private async Task HandleValidSubmit()
    {
        if (IsViewMode) return;

        IsLoading = true;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;

        try
        {
            // Set audit fields
            if (!IsEditMode)
            {
                CurrentUser.Date_Created = DateTime.Now;
                CurrentUser.Is_Activated = true;
                CurrentUser.Is_Deleted = false;
            }
            CurrentUser.Last_Modified = DateTime.Now;

            // Trigger the save event
            if (!IsEditMode)
            {

                ErrorMessage = await UserManagementServices.CreateUserAsync(CurrentUser);
            }
            if (string.IsNullOrEmpty(ErrorMessage))
            {
                SuccessMessage = IsEditMode ? "User updated successfully!" : "User created successfully!";
                // Close modal after a short delay
                await Task.Delay(1500);
                await OnUserSaved.InvokeAsync(CurrentUser);
            }
            else
            {
                SuccessMessage = string.Empty; // Clear success message if there was an error
            }


        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error saving user: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    public async Task ShowModal()
    {
        await JSRuntime.InvokeVoidAsync("bootstrap.Modal.getOrCreateInstance", "#posUserModal").AsTask();
        await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('posUserModal')).show()");
    }

    public async Task CloseModal()
    {
        AvailableRoles = new List<UserRole>
    (); // Clear roles to avoid stale data
        AvailableSites = new List<Site>
            (); // Clear sites to avoid stale data
        CurrentUser = new PosUser(); // Reset current user to avoid stale data
        IsViewMode = false; // Reset view mode
        IsEditMode = false; // Reset edit mode

        OnModalClosed.InvokeAsync();
    }

    public void SetCreateMode()
    {
        IsViewMode = false;
        IsEditMode = false;
        CurrentUser = new PosUser
        {
            Is_Activated = true,
            Is_Deleted = false,
            Date_Created = DateTime.Now,
            Last_Modified = DateTime.Now
        };
    }

    public void SetEditMode(PosUser user)
    {
        IsViewMode = false;
        IsEditMode = true;
        CurrentUser = new PosUser
        {
            User_ID = user.User_ID,
            Admin_User = user.Admin_User,
            First_Name = user.First_Name,
            Last_Name = user.Last_Name,
            Passcode = user.Passcode,
            Role_ID = user.Role_ID,
            Primary_Site_Id = user.Primary_Site_Id,
            Allowed_Void_Line = user.Allowed_Void_Line,
            Allowed_Void_Sale = user.Allowed_Void_Sale,
            Allowed_No_Sale = user.Allowed_No_Sale,
            Allowed_Returns = user.Allowed_Returns,
            Allowed_Payout = user.Allowed_Payout,
            Is_Activated = user.Is_Activated,
            Is_Deleted = user.Is_Deleted,
            Date_Created = user.Date_Created,
            Last_Modified = user.Last_Modified,
            Till_Id = user.Till_Id,
            Created_By_Id = user.Created_By_Id,
            Last_Modified_By_Id = user.Last_Modified_By_Id
        };
    }

    public void SetViewMode(PosUser user)
    {
        IsViewMode = true;
        IsEditMode = false;
        CurrentUser = user;
    }

    //Site Modal Callbacks
    private async Task OnSiteSaved(Site site)
    {
        // Logic to handle site saved event
        // For example, you might want to refresh the list of available sites
        if (site != null)
        {
            // Add the new site to the available sites list
            AvailableSites.Add(site);
            CurrentUser.Primary_Site_Id = site.Site_Id; // Set the primary site ID
        }
        showSiteModal = false; // Close the site modal after saving
    }
    @inject SiteServices SiteService; // Inject the site service to handle site operations
    private async Task OnSiteDeleted()
    {
        AvailableSites = (await SiteService.GetAllAsync()).ToList(); // Refresh roles after site deletion
        CurrentUser.Primary_Site_Id = 0; // Reset primary site if it was deleted
        showSiteModal = false; // Close the site modal after deletion
    }

}
