@page "/inventory-management"
@inject DataHandlerLibrary.Services.StockTransactionServices StockTransactionService
@inject DataHandlerLibrary.Services.ProductServices ProductService
@inject DataHandlerLibrary.Services.SiteServices SiteService
@inject DataHandlerLibrary.Services.DepartmentServices DepartmentService
@inject DataHandlerLibrary.Services.SupplierServices SupplierService
@inject DataHandlerLibrary.Services.SupplierItemsServices SupplierItemsService
@inject EposRetail.Services.UserSessionService UserSessionService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject ProductServices ProductService
@inject EposDataHandler.Services.StockOrderGenerationService StockOrderService
@using DataHandlerLibrary.Models
@using EntityFrameworkDatabaseLibrary.Models
@using EposDataHandler.Models
@using EposRetail.Components.Pages.Shared
@implements IDisposable
<PageTitle>Inventory Management</PageTitle>

<div class="inventory-management-container">
    <div class="page-header">
        <div class="header-navigation">
            <button class="btn btn-outline-secondary" @onclick="NavigateToBackOffice">
                <i class="fas fa-arrow-left"></i> Back to BackOffice
            </button>
            <button class="btn btn-outline-primary" @onclick="NavigateToCheckout">
                <i class="fas fa-cash-register"></i> Go to Checkout
            </button>
        </div>
        <h1 class="page-title">
            <i class="fas fa-warehouse"></i>
            Inventory Management
        </h1>
        <p class="page-subtitle">Manage stock transfers, orders, deliveries, and inventory operations</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <ul class="nav nav-tabs modern-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "transfers" ? "active" : "")"
                        @onclick="() => SetActiveTab(1)"
                        type="button" role="tab">
                    <i class="fas fa-exchange-alt"></i>
                    Stock Transfers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "orders" ? "active" : "")"
                        @onclick="() => SetActiveTab(2)"
                        type="button" role="tab">
                    <i class="fas fa-shopping-cart"></i>
                    Stock Orders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "deliveries" ? "active" : "")"
                        @onclick="() => SetActiveTab(3)"
                        type="button" role="tab">
                    <i class="fas fa-truck"></i>
                    Delivery Orders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "adjustments" ? "active" : "")"
                        @onclick="() => SetActiveTab(4)"
                        type="button" role="tab">
                    <i class="fas fa-edit"></i>
                    Stock Adjustments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "suppliers" ? "active" : "")"
                        @onclick="() => SetActiveTab(5)"
                        type="button" role="tab">
                    <i class="fas fa-users"></i>
                    Suppliers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "alerts" ? "active" : "")"
                        @onclick="() => SetActiveTab(6)"
                        type="button" role="tab">
                    <i class="fas fa-exclamation-triangle"></i>
                    Low Stock Alerts
                </button>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Stock Transfers Tab -->
        @if (activeTab == "transfers")
        {
            <div class="tab-pane active">
                <div class="content-header">
                    <h3>Stock Transfers</h3>
                    <button class="btn btn-primary" @onclick="ShowNewTransferModal">
                        <i class="fas fa-plus"></i> New Transfer
                    </button>
                </div>

                <div class="search-section">
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">Search Transfers</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" @bind="searchTerm" @bind:event="oninput"
                                       @onchange="OnSearchChanged" placeholder="Search by barcode or product name..." />
                                @if (!string.IsNullOrEmpty(searchTerm))
                                {
                                    <button type="button" class="btn btn-outline-secondary" @onclick="ClearSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                }
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-info" @onclick="RefreshTransfers">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pending Transfers Table -->
                @if (!string.IsNullOrEmpty(searchMessage))
                {
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> @searchMessage
                    </div>
                }
                @if ((string.IsNullOrEmpty(searchTerm) && pendingTransfers?.Any() == true) || (!string.IsNullOrEmpty(searchTerm) && filteredPendingTransfers?.Any() == true))
                {
                    <div class="pending-transfers-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Pending Transfers (@(string.IsNullOrEmpty(searchTerm) ? pendingTransfers.Count : filteredPendingTransfers.Count))</h5>
                            <button class="btn btn-success" @onclick="BulkUpdateTransfers" disabled="@(!pendingTransfers.Any())">
                                <i class="fas fa-save"></i> Update All Transfers
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover modern-table">
                                <thead>
                                    <tr>
                                        <th>Barcode</th>
                                        <th>Product</th>
                                        <th>Transfer Quantity</th>
                                        <th>Selling Price</th>
                                        <th>Total Amount</th>
                                        <th>Transfer Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var transfer in (string.IsNullOrEmpty(searchTerm) ? pendingTransfers : filteredPendingTransfers))
                                    {
                                        <tr>
                                            <td>@transfer.Product?.Product_Barcode</td>
                                            <td>@transfer.Product?.Product_Name</td>
                                            <td>@transfer.Quantity</td>
                                            <td>£@transfer.Product?.Product_Selling_Price.ToString("F2")</td>
                                            <td>£@transfer.TotalAmount.ToString("F2")</td>
                                            <td>
                                                <span class="badge bg-@GetTransferTypeBadgeColor(transfer.StockTransactionType)">
                                                    @transfer.StockTransactionType.ToString()
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-warning" @onclick="() => EditPendingTransfer(transfer)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RemovePendingTransfer(transfer)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }


            </div>

        }

        <!-- Stock Orders Tab -->
        @if (activeTab == "orders")
        {
            <div class="tab-pane active">
                <div class="content-header">
                    <h3>Stock Orders</h3>
                    <div class="d-flex gap-2">
                        @if (stockOrders?.Any() == true)
                        {
                            <button class="btn btn-outline-success" @onclick="PrintStockOrders">
                                <i class="fas fa-print"></i> Print
                            </button>
                        }
                        <button class="btn btn-primary" @onclick="GenerateStockOrder">
                            <i class="fas fa-magic"></i> Generate Order
                        </button>
                    </div>
                </div>

                @if (stockOrders?.Any() == true)
                {
                    <div class="filter-section mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Filter by Department</label>
                                <select class="form-select" value="@selectedDepartmentFilter" @onchange="OnDepartmentFilterChanged">
                                    <option value="">All Departments</option>
                                    @foreach (var dept in distinctDepartments)
                                    {
                                        <option value="@dept">@dept</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                }

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Stock orders are automatically generated based on yearly sales patterns. Analysis excludes payouts, services, and generic department sales. Forecast is for next 7 days.
                </div>

                <div class="table-responsive">
                    <table class="table table-hover modern-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Department</th>
                                <th>Current Stock</th>
                                <th>Yearly Sales</th>
                                <th>Daily Avg</th>
                                <th>7-Day Forecast</th>
                                <th>Cases Needed</th>
                                <th>Case Size</th>
                                <th>Est. Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (filteredStockOrders?.Any() == true)
                            {
                                @foreach (var order in filteredStockOrders)
                                {
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>@order.ProductName</strong>
                                                <br><small class="text-muted">@order.ProductBarcode</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@order.DepartmentName</span>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>@order.CurrentStock</strong>
                                                <br><small class="text-muted">
                                                    Total Available Stock
                                                </small>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <strong>@order.YearlySales</strong>
                                            <br><small class="text-muted">units/year</small>
                                        </td>
                                        <td class="text-center">
                                            <strong>@order.DailyAverage.ToString("F1")</strong>
                                        </td>
                                        <td class="text-center">
                                            <strong>@order.SevenDayForecast.ToString("F1")</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning text-dark fs-6">@order.RequiredCases</span>
                                        </td>
                                        <td class="text-center">
                                            @order.CaseSize
                                        </td>
                                        <td class="text-center">
                                            <strong>£@order.EstimatedCost.ToString("N2")</strong>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success" @onclick="() => CreateOrder(order)">
                                                <i class="fas fa-plus"></i> Order
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-4">
                                        @if (stockOrders == null)
                                        {
                                            <div>
                                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                                <br>Click "Generate Order" to analyze sales patterns and get stock recommendations
                                            </div>
                                        }
                                        else
                                        {
                                            <div>
                                                <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                                                <br>All products are well stocked for the next 7 days based on sales analysis
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- Delivery Orders Tab -->
        @if (activeTab == "deliveries")
        {
            <div class="tab-pane active">
                <div class="content-header">
                    <h3>Delivery Orders</h3>
                </div>

                <div class="delivery-entry-form">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Product Delivery Entry</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Barcode</label>
                                        <input type="text" class="form-control" @bind="deliveryProductBarcode"
                                               @ref="deliveryBarcodeInput"
                                               @onkeypress="HandleBarcodeKeyPress"
                                               placeholder="Scan or enter barcode" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Product Name</label>
                                        <input type="text" class="form-control" @bind="deliveryProductName" placeholder="Enter product name" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Selling Price (£)</label>
                                        <input type="number" class="form-control" @bind="deliverySellingPrice" step="0.01" placeholder="0.00" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Department</label>
                                        <select class="form-select" @bind="deliveryDepartmentId">
                                            <option value="">Select Department</option>
                                            @foreach (var dept in departments)
                                            {
                                                <option value="@dept.Department_ID">@dept.Department_Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Supplier</label>
                                        <select class="form-select" @bind="deliverySupplierId">
                                            <option value="">Select Supplier</option>
                                            @foreach (var supplier in suppliers)
                                            {
                                                <option value="@supplier.Supplier_ID">@supplier.Supplier_Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Units per Case</label>
                                        <input type="number" class="form-control" @bind="deliveryUnitsPerCase" min="1" placeholder="Enter units per case" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Cost per Case (£)</label>
                                        <input type="number" class="form-control" @bind="deliveryCostPerCase" step="0.01" placeholder="0.00" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Current Quantity</label>
                                        <input type="number" class="form-control" value="@deliveryCurrentQuantity" readonly />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Cost per Product (£)</label>
                                        <input type="number" class="form-control" value="@deliveryCostPerProduct" readonly />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Delivered Cases</label>
                                        <input type="number" class="form-control" @bind="deliveryDeliveredCases" min="0" placeholder="Enter delivered cases" />
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group mb-3 d-flex align-items-end" style="height: 100%;">
                                        <button class="btn btn-success me-2" @onclick="AddDeliveryProduct">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                        <button class="btn btn-secondary me-2" @onclick="ClearDeliveryForm">
                                            <i class="fas fa-eraser"></i> Clear
                                        </button>
                                        <button class="btn btn-primary" @onclick="EditDeliveryProduct">
                                            <i class="fas fa-edit"></i> Edit Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delivery Items Table -->
            @if (deliveryItems.Any())
            {
                <div class="delivery-items-section mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-list"></i> Delivery Items (@deliveryItems.Count)</h4>
                        <div>
                            <button class="btn btn-success me-2" @onclick="ConfirmDelivery">
                                <i class="fas fa-check"></i> Confirm Delivery
                            </button>
                            <button class="btn btn-outline-danger" @onclick="ClearAllDeliveryItems">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover modern-table">
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Product Name</th>
                                    <th>Department</th>
                                    <th>Units/Case</th>
                                    <th>Cost/Case</th>
                                    <th>Cases</th>
                                    <th>Total Units</th>
                                    <th>Total Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in deliveryItems)
                                {
                                    <tr>
                                        <td>@item.Barcode</td>
                                        <td>@item.ProductName</td>
                                        <td>@item.DepartmentName</td>
                                        <td>@item.UnitsPerCase</td>
                                        <td>£@item.CostPerCase.ToString("F2")</td>
                                        <td>@item.DeliveredCases</td>
                                        <td>@item.TotalUnits</td>
                                        <td>£@item.TotalCost.ToString("F2")</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveDeliveryItem(item)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="6"><strong>Total:</strong></td>
                                    <td><strong>@deliveryItems.Sum(i => i.TotalUnits)</strong></td>
                                    <td><strong>£@deliveryItems.Sum(i => i.TotalCost).ToString("F2")</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            }

        }

        <!-- Suppliers Tab -->
        @if (activeTab == "suppliers")
        {
            <div class="tab-pane active">
                <div class="content-header">
                    <h3>Supplier Management</h3>
                    <button class="btn btn-primary" @onclick="ShowNewSupplierModal">
                        <i class="fas fa-plus"></i> Add Supplier
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover modern-table">
                        <thead>
                            <tr>
                                <th>Supplier Name</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Credit Limit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ABC Wholesale Ltd</td>
                                <td>+44 123 456 7890</td>
                                <td>orders@abcwholesale.com</td>
                                <td>£5,000.00</td>
                                <td><span class="badge bg-success">Active</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6" class="text-center text-muted">More suppliers will be displayed here</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- Low Stock Alerts Tab -->
        @if (activeTab == "alerts")
        {
            <div class="tab-pane active">
                <div class="content-header">
                    <h3>Low Stock Alerts</h3>
                    <button class="btn btn-warning" @onclick="RefreshAlerts">
                        <i class="fas fa-sync-alt"></i> Refresh Alerts
                    </button>
                </div>

                <div class="alert-summary">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert-card critical">
                                <div class="alert-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="alert-info">
                                    <h4>@criticalStockCount</h4>
                                    <p>Critical Stock</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert-card low">
                                <div class="alert-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="alert-info">
                                    <h4>@lowStockCount</h4>
                                    <p>Low Stock</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert-card expired">
                                <div class="alert-icon">
                                    <i class="fas fa-calendar-times"></i>
                                </div>
                                <div class="alert-info">
                                    <h4>@expiredStockCount</h4>
                                    <p>Expired Items</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover modern-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Min Stock Level</th>
                                <th>Alert Type</th>
                                <th>Expiry Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (lowStockProducts?.Any() == true)
                            {
                                @foreach (var product in lowStockProducts)
                                {
                                    <tr class="@GetAlertRowClass(product)">
                                        <td>@product.Product_Name</td>
                                        <td>@product.ProductTotalQuantity</td>
                                        <td>@product.Product_Min_Stock_Level</td>
                                        <td>
                                            <span class="badge bg-@GetStockAlertBadgeColor(product)">
                                                @GetStockAlertType(product)
                                            </span>
                                        </td>
                                        <td>@(product.Expiry_Date.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                        <td>
                                            <button class="btn btn-sm btn-success" @onclick="() => QuickReorder(product)">
                                                <i class="fas fa-shopping-cart"></i> Reorder
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-success">
                                        <i class="fas fa-check-circle"></i> All products are adequately stocked
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
</div>


<!-- New Transfer Modal -->
<div class="modal fade @(showNewTransferModal ? "show d-block" : "")" tabindex="-1" style="@(showNewTransferModal ? "background-color: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> New Stock Transfer
                </h5>
                <button type="button" class="btn-close" @onclick="CloseNewTransferModal"></button>
            </div>
            <div class="modal-body">
                <form @onsubmit="AddPendingTransfer" @onsubmit:preventDefault="true">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Barcode <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" @bind-value="newTransfer.Barcode" @bind-value:event="oninput"
                                       @onchange="OnBarcodeChanged" placeholder="Scan or enter barcode"
                                       @ref="barcodeInput" autofocus />
                                <button type="button" class="btn btn-outline-secondary" @onclick="FocusBarcodeInput">
                                    <i class="fas fa-barcode"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Product Name</label>
                            <input type="text" class="form-control" value="@newTransfer.ProductName" readonly />
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">Selling Price</label>
                            <div class="input-group">
                                <span class="input-group-text">£</span>
                                <input type="text" class="form-control" value="@(newTransfer.SellingPrice.ToString("F2"))" readonly />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Current Stock</label>
                            <input type="text" class="form-control" value="@newTransfer.CurrentStock" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Transfer Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" @bind="newTransfer.TransferQuantity"
                                   min="1" step="1" placeholder="Enter quantity" />
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Transfer Type <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="newTransfer.TransferType">
                                <option value="@StockTransferType.StockIn">Stock In</option>
                                <option value="@StockTransferType.StockOut">Stock Out</option>
                                <option value="@StockTransferType.Transfer">Transfer</option>
                                <option value="@StockTransferType.Adjustment">Adjustment</option>
                                <option value="@StockTransferType.Damaged">Damaged</option>
                                <option value="@StockTransferType.Expired">Expired</option>
                                <option value="@StockTransferType.Theft">Theft</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">£</span>
                                <input type="text" class="form-control" value="@(newTransfer.TotalAmount.ToString("F2"))" readonly />
                            </div>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(transferError))
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="fas fa-exclamation-triangle"></i> @transferError
                        </div>
                    }
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseNewTransferModal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" @onclick="AddPendingTransfer"
                        disabled="@(string.IsNullOrEmpty(newTransfer.Barcode) ||
                                                                                                                                                                                                                                                  newTransfer.Product == null ||
                                                                                                                                                                                                                                                  newTransfer.TransferQuantity <= 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )">
                    <i class="fas fa-plus"></i> Add Transfer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transfer Modal -->
<div class="modal fade @(showEditTransferModal ? "show d-block" : "")" tabindex="-1" style="@(showEditTransferModal ? "background-color: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Edit Stock Transfer
                </h5>
                <button type="button" class="btn-close" @onclick="CloseEditTransferModal"></button>
            </div>
            <div class="modal-body">
                @if (editingTransfer != null)
                {
                    <form @onsubmit="UpdatePendingTransfer" @onsubmit:preventDefault="true">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Product Name</label>
                                <input type="text" class="form-control" value="@editingTransfer.Product?.Product_Name" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Barcode</label>
                                <input type="text" class="form-control" value="@editingTransfer.Product?.Product_Barcode" readonly />
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Transfer Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" @bind="editingTransfer.Quantity"
                                       min="1" step="1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transfer Type <span class="text-danger">*</span></label>
                                <select class="form-select" @bind="editingTransfer.StockTransactionType">
                                    <option value="@StockTransferType.StockIn">Stock In</option>
                                    <option value="@StockTransferType.StockOut">Stock Out</option>
                                    <option value="@StockTransferType.Transfer">Transfer</option>
                                    <option value="@StockTransferType.Adjustment">Adjustment</option>
                                    <option value="@StockTransferType.Damaged">Damaged</option>
                                    <option value="@StockTransferType.Expired">Expired</option>
                                    <option value="@StockTransferType.Theft">Theft</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">£</span>
                                    <input type="text" class="form-control" value="@(editingTransfer.TotalAmount.ToString("F2"))" readonly />
                                </div>
                            </div>
                        </div>
                    </form>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseEditTransferModal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" @onclick="UpdatePendingTransfer">
                    <i class="fas fa-save"></i> Update Transfer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Exit Confirmation Modal -->
<div class="modal fade @(showExitConfirmModal ? "show d-block" : "")" tabindex="-1" style="@(showExitConfirmModal ? "background-color: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Unsaved Changes
                </h5>
            </div>
            <div class="modal-body">
                <p>You have @pendingTransfers?.Count unsaved stock transfers. Would you like to update the stock transfers before exiting?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="ExitWithoutSaving">
                    <i class="fas fa-times"></i> Exit Without Saving
                </button>
                <button type="button" class="btn btn-primary" @onclick="SaveAndExit">
                    <i class="fas fa-save"></i> Save and Exit
                </button>
                <button type="button" class="btn btn-outline-secondary" @onclick="CancelExit">
                    <i class="fas fa-arrow-left"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generic Message Modal -->
<GenericMessageModal IsVisible="showMessageModal"
                     Title="@modalTitle"
                     Message="@modalMessage"
                     PrimaryButtonText="OK"
                     PrimaryAction="CloseMessageModal"
                     OnClose="CloseMessageModal" />

@if (showProductModal)
{
    <ProductModal IsVisible="@showProductModal" Product="@selectedProductForModal" OnSave="@SaveProductModal" OnClose="@CloseProductModal" />

}


<!-- Confirm Exit Modal -->
@if (showConfirmExitModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@confirmExitTitle</h5>
                </div>
                <div class="modal-body">
                    <p>@confirmExitMessage</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" @onclick="ConfirmAndExit">
                        <i class="fas fa-check"></i> Yes, Finalize & Exit
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="ExitWithoutSaving">
                        <i class="fas fa-times"></i> No, Exit Without Saving
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="CancelExit">
                        <i class="fas fa-ban"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "transfers";
    private List<StockTransaction>? stockTransfers;
    private List<StockOrderModel>? stockOrders;
    private List<StockOrderModel>? filteredStockOrders;
    private List<Department>? departments;
    private List<StockTransaction>? adjustments;
    private List<Product>? lowStockProducts;
    private List<StockTransaction> pendingTransfers = new List<StockTransaction>();
    private string searchTerm = "";
    private List<StockTransaction> filteredPendingTransfers = new List<StockTransaction>();
    private string searchMessage = "";
    private string selectedDepartmentFilter = "";
    private List<string> distinctDepartments = new();
    private int criticalStockCount = 0;
    private int lowStockCount = 0;
    private int expiredStockCount = 0;

    // Modal states
    private bool showNewTransferModal = false;
    private bool showEditTransferModal = false;
    private bool showExitConfirmModal = false;
    private StockTransaction? editingTransfer;
    private string transferError = "";
    private string pendingExitAction = "";

    // New transfer form
    private NewTransferModel newTransfer = new NewTransferModel();
    private ElementReference barcodeInput;

    // Transfer form model
    public class NewTransferModel
    {
        public string Barcode { get; set; } = "";
        public string ProductName { get; set; } = "";
        public decimal SellingPrice { get; set; }
        public int CurrentStock { get; set; }
        public int TransferQuantity { get; set; }
        public StockTransferType TransferType { get; set; }
        public decimal TotalAmount => TransferQuantity * SellingPrice;
        public Product? Product { get; set; }
    }

    public class DeliveryItem
    {
        public string Barcode { get; set; } = "";
        public string ProductName { get; set; } = "";
        public string DepartmentName { get; set; } = "";
        public int UnitsPerCase { get; set; }
        public decimal CostPerCase { get; set; }
        public decimal CostPerUnit { get; set; }
        public int DeliveredCases { get; set; }
        public int TotalUnits { get; set; }
        public decimal TotalCost { get; set; }
        public Product? Product { get; set; }
        public DateTime DateAdded { get; set; } = DateTime.Now;
    }

    // Delivery form variables
    private string deliveryProductBarcode = "";
    private string deliveryProductName = "";
    private decimal deliverySellingPrice = 0;
    private int deliveryDepartmentId = 0;
    private int deliverySupplierId = 0;
    private int deliveryUnitsPerCase = 1;
    private decimal deliveryCostPerCase = 0;
    private int deliveryCurrentQuantity = 0;
    private decimal deliveryCostPerProduct => deliveryUnitsPerCase > 0 ? deliveryCostPerCase / deliveryUnitsPerCase : 0;
    private int deliveryDeliveredCases = 0;
    private Product? deliveryProduct;
    private ElementReference deliveryBarcodeInput;

    // Delivery items list
    private List<DeliveryItem> deliveryItems = new();
    private bool hasUnsavedDeliveryChanges => deliveryItems.Any();

    // Confirmation modal variables
    private bool showConfirmExitModal = false;
    private string confirmExitTitle = "";
    private string confirmExitMessage = "";
    private string pendingTabChange = "";

    // Product Modal variables
    private bool showProductModal = false;
    private Product? selectedProductForModal;
    private List<Supplier>? suppliers = new();

    // Modal state variables for GenericMessageModal
    private bool showMessageModal = false;
    private string modalTitle = string.Empty;
    private string modalMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadDepartments();

        // Add navigation protection
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Check if user is navigating away with unsaved changes
        if (hasUnsavedDeliveryChanges && !e.Location.Contains("inventory-management"))
        {
            // Note: In a real application, you might want to show a confirmation dialog
            // For now, we'll just clear the items to prevent memory leaks
            deliveryItems.Clear();
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadData()
    {
        try
        {
            await LoadLowStockAlerts();
            filteredPendingTransfers = pendingTransfers?.ToList() ?? new List<StockTransaction>();
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private async Task LoadLowStockAlerts()
    {
        var allProducts = await ProductService.GetAllAsync(false);
        lowStockProducts = allProducts?.Where(p =>
        p.ProductTotalQuantity <= p.Product_Min_Stock_Level &&
        p.Is_activated == true &&
        p.Is_deleted == false).ToList();

        criticalStockCount = lowStockProducts?.Count(p => p.ProductTotalQuantity == 0) ?? 0;
        lowStockCount = lowStockProducts?.Count(p => p.ProductTotalQuantity > 0 && p.ProductTotalQuantity <= p.Product_Min_Stock_Level) ?? 0;
        expiredStockCount = allProducts?.Count(p => p.Expiry_Date < DateTime.Now) ?? 0;
    }

    private async Task LoadDepartments()
    {
        try
        {
            var allDepartments = await DepartmentService.GetAllAsync(false);
            departments = allDepartments?.OrderBy(d => d.Department_Name).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading departments: {ex.Message}");
        }
    }

    private async Task FilterStockOrdersByDepartment()
    {
        if (stockOrders == null)
        {
            filteredStockOrders = new List<StockOrderModel>();
            return;
        }

        if (string.IsNullOrEmpty(selectedDepartmentFilter))
        {
            filteredStockOrders = stockOrders.ToList();
        }
        else
        {
            filteredStockOrders = stockOrders
            .Where(order => order.DepartmentName == selectedDepartmentFilter)
            .ToList();
        }

        StateHasChanged();
    }

    private void OnDepartmentFilterChanged(ChangeEventArgs e)
    {
        selectedDepartmentFilter = e.Value?.ToString();
        FilterStockOrdersByDepartment();
    }

    private async Task PrintStockOrders()
    {
        if (filteredStockOrders?.Any() != true)
        {
            modalTitle = "No Data";
            modalMessage = "No stock orders available to print.";
            showMessageModal = true;
            return;
        }

        try
        {
            await JSRuntime.InvokeVoidAsync("window.print");
        }
        catch (Exception ex)
        {
            modalTitle = "Print Error";
            modalMessage = $"Failed to print: {ex.Message}";
            showMessageModal = true;
        }
    }

    private async Task SetActiveTab(int tab)
    {
        string newTab = tab switch
        {
            1 => "transfers",
            2 => "orders",
            3 => "deliveries",
            4 => "adjustments",
            5 => "suppliers",
            6 => "alerts",
            _ => "transfers"
        };

        // Check if leaving deliveries tab with unsaved changes
        if (activeTab == "deliveries" && newTab != "deliveries" && hasUnsavedDeliveryChanges)
        {
            pendingTabChange = newTab;
            confirmExitTitle = "Unsaved Delivery Changes";
            confirmExitMessage = "You have unsaved delivery items. Would you like to finalize the delivery and exit?";
            showConfirmExitModal = true;
            return;
        }

        await OnTabChanged(newTab);
    }

    private async Task OnSearchChanged()
    {
        await SearchTransfers();
    }

    private async Task SearchTransfers()
    {
        if (!string.IsNullOrEmpty(searchTerm))
        {
            var searchLower = searchTerm.ToLower();
            filteredPendingTransfers = pendingTransfers?.Where(t =>
            (t.Product?.Product_Barcode != null && t.Product.Product_Barcode.ToLower().Contains(searchLower)) ||
            (t.Product?.Product_Name != null && t.Product.Product_Name.ToLower().Contains(searchLower))
            ).ToList() ?? new List<StockTransaction>();

            if (!filteredPendingTransfers.Any())
            {
                searchMessage = "This product hasn't been scanned for stock transfer.";
            }
            else
            {
                searchMessage = "";
            }
        }
        else
        {
            filteredPendingTransfers = pendingTransfers?.ToList() ?? new List<StockTransaction>();
            searchMessage = "";
        }

        StateHasChanged();
    }

    private async Task ClearSearch()
    {
        searchTerm = "";
        filteredPendingTransfers = pendingTransfers?.ToList() ?? new List<StockTransaction>();
        searchMessage = "";
        StateHasChanged();
    }

    private async Task RefreshTransfers()
    {
        searchTerm = "";
        StateHasChanged();
    }

    private async Task FilterByAdjustmentType(StockTransferType type)
    {
        adjustments = stockTransfers?.Where(t => t.StockTransactionType == type).ToList();
        StateHasChanged();
    }

    private string GetTransferTypeBadgeColor(StockTransferType type)
    {
        return type switch
        {
            StockTransferType.StockIn => "success",
            StockTransferType.StockOut => "warning",
            StockTransferType.Transfer => "info",
            StockTransferType.Adjustment => "secondary",
            StockTransferType.Damaged => "danger",
            StockTransferType.Expired => "dark",
            StockTransferType.Theft => "danger",
            _ => "secondary"
        };
    }

    private string GetAdjustmentTypeBadgeColor(StockTransferType type)
    {
        return GetTransferTypeBadgeColor(type);
    }

    private string GetStockAlertBadgeColor(Product product)
    {
        if (product.ProductTotalQuantity <= 0) return "danger";
        if (product.ProductTotalQuantity <= product.Product_Min_Stock_Level) return "warning";
        if (product.Expiry_Date < DateTime.Now) return "dark";
        return "success";
    }

    private string GetStockAlertType(Product product)
    {
        if (product.ProductTotalQuantity <= 0) return "Out of Stock";
        if (product.ProductTotalQuantity <= product.Product_Min_Stock_Level) return "Low Stock";
        if (product.Expiry_Date < DateTime.Now) return "Expired";
        return "Normal";
    }

    private string GetAlertRowClass(Product product)
    {
        if (product.ProductTotalQuantity == 0) return "table-danger";
        if (product.Expiry_Date < DateTime.Now) return "table-dark";
        return "table-warning";
    }

    // Navigation methods
    private void NavigateToBackOffice()
    {
        if (pendingTransfers.Any())
        {
            pendingExitAction = "backoffice";
            showExitConfirmModal = true;
        }
        else
        {
            NavigationManager.NavigateTo("/backoffice");
        }
    }

    private void NavigateToCheckout()
    {
        if (pendingTransfers.Any())
        {
            pendingExitAction = "checkout";
            showExitConfirmModal = true;
        }
        else
        {
            NavigationManager.NavigateTo("/checkout");
        }
    }

    // Modal and action methods
    private void ShowNewTransferModal()
    {
        newTransfer = new NewTransferModel();
        transferError = "";
        showNewTransferModal = true;
        StateHasChanged();

        // Focus on barcode input after modal opens
        Task.Run(async () =>
        {
            await Task.Delay(100);
            await InvokeAsync(async () =>
        {
            await barcodeInput.FocusAsync();
        });
        });
    }

    private void CloseNewTransferModal()
    {
        showNewTransferModal = false;
        newTransfer = new NewTransferModel();
        transferError = "";
    }

    private async Task OnBarcodeChanged()
    {
        if (!string.IsNullOrEmpty(newTransfer.Barcode))
        {
            await LoadProductByBarcode(newTransfer.Barcode);
        }
    }

    private async Task LoadProductByBarcode(string barcode)
    {
        try
        {
            // Get product by barcode from the service
            var allProducts = await ProductService.GetAllAsync(false);
            var product = allProducts?.FirstOrDefault(p => p.Product_Barcode == barcode);

            if (product != null)
            {
                newTransfer.Product = product;
                newTransfer.ProductName = product.Product_Name ?? "";
                newTransfer.SellingPrice = product.Product_Selling_Price;
                newTransfer.CurrentStock = product.ProductTotalQuantity;
                transferError = "";
            }
            else
            {
                transferError = "Product not found for barcode: " + barcode;
                newTransfer.ProductName = "";
                newTransfer.SellingPrice = 0;
                newTransfer.CurrentStock = 0;
            }
        }
        catch (Exception ex)
        {
            transferError = "Error loading product: " + ex.Message;
        }

        StateHasChanged();
    }

    private bool ValidateNewTransfer()
    {
        if (string.IsNullOrEmpty(newTransfer.Barcode))
        {
            transferError = "Barcode is required";
            return false;
        }

        if (newTransfer.Product == null)
        {
            transferError = "Product not found";
            return false;
        }

        if (newTransfer.TransferQuantity <= 0)
        {
            transferError = "Transfer quantity must be greater than 0";
            return false;
        }

        return true;
    }

    private void EditPendingTransfer(StockTransaction transfer)
    {
        editingTransfer = transfer;
        newTransfer = new NewTransferModel
        {
            Barcode = transfer.Product?.Product_Barcode ?? "",
            ProductName = transfer.Product?.Product_Name ?? "",
            SellingPrice = transfer.Product?.Product_Selling_Price ?? 0,
            CurrentStock = transfer.Product?.ProductTotalQuantity ?? 0,
            TransferQuantity = transfer.Quantity,
            Product = transfer.Product
        };
        showEditTransferModal = true;
    }

    private void UpdatePendingTransfer()
    {
        if (editingTransfer != null && ValidateNewTransfer())
        {
            editingTransfer.Quantity = newTransfer.TransferQuantity;
            editingTransfer.TotalAmount = newTransfer.TotalAmount;
            CloseEditTransferModal();
        }
    }

    private void CloseEditTransferModal()
    {
        showEditTransferModal = false;
        editingTransfer = null;
        newTransfer = new NewTransferModel();
        transferError = "";
    }

    private void RemovePendingTransfer(StockTransaction transfer)
    {
        pendingTransfers.Remove(transfer);
    }

    private async Task BulkUpdateTransfers()
    {
        try
        {
            List<Product> productsToUpdate = new List<Product>();
            if (!pendingTransfers.Any())
            {
                transferError = "No pending transfers to update.";
                return;
            }
            foreach (var transfer in pendingTransfers)
            {
                if (transfer.Product != null)
                {
                    transfer.Product.Last_Modified = DateTime.UtcNow;
                    transfer.Product.Last_Modified_By_Id = UserSessionService.GetCurrentUserId();
                    transfer.Product.StockroomQuantity += transfer.Quantity;
                    productsToUpdate.Add(transfer.Product);
                }
            }

            await ProductService.BulkUpdateAsync(productsToUpdate);
            await StockTransactionService.AddBulkEntityAsync(pendingTransfers);



            pendingTransfers.Clear();
            await LoadData(); // Refresh the existing transfers

            // Show success message
            transferError = "";
        }
        catch (Exception ex)
        {
            transferError = "Error updating transfers: " + ex.Message;
        }
    }

    // Exit confirmation methods
    private void ConfirmUpdateAndExit()
    {
        Task.Run(async () =>
        {
            await BulkUpdateTransfers();
            await InvokeAsync(() =>
        {
            showExitConfirmModal = false;
            if (pendingExitAction == "backoffice")
            {
                NavigationManager.NavigateTo("/backoffice");
            }
            else if (pendingExitAction == "checkout")
            {
                NavigationManager.NavigateTo("/checkout");
            }
        });
        });
    }

    private void ExitWithoutSaving()
    {
        pendingTransfers.Clear();
        showExitConfirmModal = false;

        if (pendingExitAction == "backoffice")
        {
            NavigationManager.NavigateTo("/backoffice");
        }
        else if (pendingExitAction == "checkout")
        {
            NavigationManager.NavigateTo("/checkout");
        }
    }



    private async Task ShowNewDeliveryModal()
    {
        // Implementation for new delivery modal
        await JSRuntime.InvokeVoidAsync("alert", "New Delivery Modal - To be implemented");
    }

    private async Task ShowNewAdjustmentModal()
    {
        // Implementation for new adjustment modal
        await JSRuntime.InvokeVoidAsync("alert", "New Adjustment Modal - To be implemented");
    }

    private async Task ShowNewSupplierModal()
    {
        // Implementation for new supplier modal
        await JSRuntime.InvokeVoidAsync("alert", "New Supplier Modal - To be implemented");
    }

    private async Task GenerateStockOrder()
    {
        try
        {
            // Generate stock orders based on yearly sales patterns for next 7 days
            var stockOrderReport = await StockOrderService.GetDetailedStockOrderReportAsync();
            stockOrders = stockOrderReport.StockOrders.ToList();

            // Generate distinct departments for filter
            distinctDepartments = stockOrders?.Select(o => o.DepartmentName).Distinct().OrderBy(d => d).ToList() ?? new();

            // Reset filter and apply current department filter
            selectedDepartmentFilter = "";
            await FilterStockOrdersByDepartment();

            if (stockOrders.Any())
            {
                modalTitle = "Stock Order Generated";
                modalMessage = $"Stock order generated successfully! Found {stockOrderReport.TotalProductsAnalyzed} products requiring restocking for the next 7 days based on yearly sales patterns.";
                showMessageModal = true;
            }
            else
            {
                modalTitle = "Stock Analysis Complete";
                modalMessage = "Stock analysis completed. All active products have sufficient stock for the next 7 days based on sales patterns.";
                showMessageModal = true;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            modalTitle = "Error";
            modalMessage = $"Failed to generate stock order: {ex.Message}";
            showMessageModal = true;
            StateHasChanged();
        }
    }

    private async Task RefreshAlerts()
    {
        await LoadLowStockAlerts();
        StateHasChanged();
    }

    private async Task ViewTransfer(int transferId)
    {
        // Implementation for viewing transfer details
        await JSRuntime.InvokeVoidAsync("alert", $"View Transfer {transferId} - To be implemented");
    }

    private async Task DeleteTransfer(int transferId)
    {
        // Implementation for deleting transfer
        await JSRuntime.InvokeVoidAsync("alert", $"Delete Transfer {transferId} - To be implemented");
    }

    private async Task CreateOrder(StockOrderModel order)
    {
        // Implementation for creating order
        await JSRuntime.InvokeVoidAsync("alert", $"Create Order for {order.ProductName} - To be implemented");
    }

    private async Task QuickReorder(Product product)
    {
        // Implementation for quick reorder
        await JSRuntime.InvokeVoidAsync("alert", $"Quick Reorder for {product.Product_Name} - To be implemented");
    }


    private async Task FocusBarcodeInput(MouseEventArgs args)
    {
        await barcodeInput.FocusAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDepartments();
            await LoadSuppliers();
        }

        if (activeTab == "deliveries")
        {
            await FocusDeliveryBarcode();
        }
    }

    // Delivery form methods
    private async Task HandleBarcodeKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(deliveryProductBarcode))
        {
            await SearchProductByBarcode();
            
        }
    }

    private async Task SearchProductByBarcode()
    {
        try
        {
            var product = await ProductService.GetProductByBarcode(deliveryProductBarcode.Trim(), false, false);
            if (product != null)
            {
                deliveryProduct = product;
                deliveryProductName = product.Product_Name;
                deliverySellingPrice = product.Product_Selling_Price;
                deliveryDepartmentId = product.Department_ID;
                deliveryCurrentQuantity = product.ProductTotalQuantity;

                // Load supplier information if available
                var supplierItem = await SupplierItemsService.GetSupplierItemByProductIdAsync(product.Product_ID);
                if (supplierItem != null)
                {
                    deliverySupplierId = supplierItem.SupplierId;
                    deliveryUnitsPerCase = supplierItem.Unit_Per_Case;
                    deliveryCostPerCase = supplierItem.Cost_Per_Case;
                }

                StateHasChanged();
            }
            else
            {
                modalTitle = "Product Not Found";
                modalMessage = "No product found with the barcode: " + deliveryProductBarcode;
                showMessageModal = true;
            }
        }
        catch (Exception ex)
        {
            modalTitle = "Error";
            modalMessage = "Error searching product: " + ex.Message;
            showMessageModal = true;
        }
    }

    private async Task LoadSuppliers()
    {
        try
        {
            var allSuppliers = await SupplierService.GetAllAsync(false);
            suppliers = allSuppliers?.OrderBy(s => s.Supplier_Name).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading suppliers: {ex.Message}");
        }
    }

    private async Task EditDeliveryProduct()
    {
        if (deliveryProduct != null)
        {
            selectedProductForModal = deliveryProduct;
            showProductModal = true;
        }
        else if (!string.IsNullOrWhiteSpace(deliveryProductBarcode))
        {
            // Try to find product by barcode first
            var product = await ProductService.GetProductByBarcode(deliveryProductBarcode.Trim(), false, false);
            if (product != null)
            {
                selectedProductForModal = product;
                showProductModal = true;
            }
            else
            {
                modalTitle = "Product Not Found";
                modalMessage = "No product found. Please search for a product first.";
                showMessageModal = true;
            }
        }
        else
        {
            modalTitle = "No Product Selected";
            modalMessage = "Please search for a product using barcode before editing.";
            showMessageModal = true;
        }
    }

    private void CloseProductModal()
    {
        showProductModal = false;
        selectedProductForModal = null;
    }

    private async Task SaveProductModal(Product product)
    {
        if (product != null)
        {
            try
            {
                product.Last_Modified = DateTime.UtcNow;
                product.Last_Modified_By_Id = UserSessionService.GetCurrentUserId();

                await ProductService.UpdateAsync(product);

                // Update delivery form with saved changes
                if (deliveryProduct?.Product_ID == product.Product_ID)
                {
                    deliveryProduct = product;
                    deliveryProductName = product.Product_Name;
                    deliverySellingPrice = product.Product_Selling_Price;
                    deliveryDepartmentId = product.Department_ID;
                    deliveryCurrentQuantity = product.ProductTotalQuantity;
                }

                // Update the selected product reference
                selectedProductForModal = product;

                CloseProductModal();
                modalTitle = "Success";
                modalMessage = "Product updated successfully!";
                showMessageModal = true;
            }
            catch (Exception ex)
            {
                modalTitle = "Error";
                modalMessage = "Error saving product: " + ex.Message;
                showMessageModal = true;
            }
        }
    }

    private async Task FocusDeliveryBarcode()
    {
        await Task.Delay(100); // Small delay to ensure DOM is ready
        await deliveryBarcodeInput.FocusAsync();
    }

    private async Task OnTabChanged(string newTab)
    {
        activeTab = newTab;
        if (activeTab == "deliveries")
        {
            await LoadSuppliers();
            await FocusDeliveryBarcode();
        }
    }

    private async Task CloseMessageModal()
    {
        showMessageModal = false;
        StateHasChanged();
    }

    private async Task AddDeliveryProduct()
    {
        try
        {
            // Validate required fields
            if (string.IsNullOrEmpty(deliveryProductBarcode) || string.IsNullOrEmpty(deliveryProductName))
            {
                modalTitle = "Validation Error";
                modalMessage = "Please enter both barcode and product name.";
                showMessageModal = true;
                StateHasChanged();
                return;
            }

            if (deliveryDepartmentId <= 0)
            {
                modalTitle = "Validation Error";
                modalMessage = "Please select a department.";
                showMessageModal = true;
                StateHasChanged();
                return;
            }

            if (deliveryDeliveredCases <= 0)
            {
                modalTitle = "Validation Error";
                modalMessage = "Please enter a valid number of delivered cases.";
                showMessageModal = true;
                StateHasChanged();
                return;
            }

            // Check if product already exists in delivery items
            var existingItem = deliveryItems.FirstOrDefault(item => item.Barcode == deliveryProductBarcode);
            if (existingItem != null)
            {
                modalTitle = "Duplicate Product";
                modalMessage = "This product is already in the delivery list. Please edit the existing entry or use a different product.";
                showMessageModal = true;
                StateHasChanged();
                return;
            }

            // Get department name
            var department = departments?.FirstOrDefault(d => d.Department_ID == deliveryDepartmentId);
            string departmentName = department?.Department_Name ?? "Unknown";

            // Calculate values
            int totalUnits = deliveryDeliveredCases * deliveryUnitsPerCase;
            decimal totalCost = deliveryDeliveredCases * deliveryCostPerCase;

            // Create delivery item
            var deliveryItem = new DeliveryItem
            {
                Barcode = deliveryProductBarcode,
                ProductName = deliveryProductName,
                DepartmentName = departmentName,
                UnitsPerCase = deliveryUnitsPerCase,
                CostPerCase = deliveryCostPerCase,
                CostPerUnit = deliveryCostPerProduct,
                DeliveredCases = deliveryDeliveredCases,
                TotalUnits = totalUnits,
                TotalCost = totalCost,
                Product = deliveryProduct
            };

            // Add to delivery items list
            deliveryItems.Add(deliveryItem);

            modalTitle = "Product Added";
            modalMessage = $"Successfully added {deliveryProductName} to delivery list.";
            showMessageModal = true;

            // Clear form after successful addition
            await ClearDeliveryForm();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            modalTitle = "Error";
            modalMessage = $"Failed to add delivery: {ex.Message}";
            showMessageModal = true;
            StateHasChanged();
        }


    }

    private async Task ClearDeliveryForm()
    {
        deliveryProductBarcode = "";
        deliveryProductName = "";
        deliverySellingPrice = 0;
        deliveryDepartmentId = 0;
        deliverySupplierId = 0;
        deliveryUnitsPerCase = 1;
        deliveryCostPerCase = 0;
        deliveryCurrentQuantity = 0;
        deliveryDeliveredCases = 0;

        StateHasChanged();
    }

    private void RemoveDeliveryItem(DeliveryItem item)
    {
        deliveryItems.Remove(item);
        StateHasChanged();
    }

    private async Task ClearAllDeliveryItems()
    {
        deliveryItems.Clear();
        StateHasChanged();
    }

    private async Task ConfirmDelivery()
    {
        if (!deliveryItems.Any())
        {
            modalTitle = "No Items";
            modalMessage = "No delivery items to confirm.";
            showMessageModal = true;
            return;
        }

        try
        {
            // Here you would typically save the delivery to the database
            // For now, we'll just show a success message and clear the items

            int totalItems = deliveryItems.Count;
            int totalUnits = deliveryItems.Sum(i => i.TotalUnits);
            decimal totalCost = deliveryItems.Sum(i => i.TotalCost);

            modalTitle = "Delivery Confirmed";
            modalMessage = $"Successfully confirmed delivery of {totalItems} products ({totalUnits} total units) worth £{totalCost:F2}.";
            showMessageModal = true;

            // Clear delivery items after confirmation
            deliveryItems.Clear();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            modalTitle = "Error";
            modalMessage = $"Failed to confirm delivery: {ex.Message}";
            showMessageModal = true;
        }
    }

    private async Task ConfirmAndExit()
    {
        // Finalize the delivery first
        await ConfirmDelivery();

        // Then change to the pending tab
        showConfirmExitModal = false;
        await OnTabChanged(pendingTabChange);
    }

    private void CancelExit()
    {
        // Just close the modal and stay on current tab
        showConfirmExitModal = false;
        pendingTabChange = "";
    }


    private void AddPendingTransfer()
    {
        if (string.IsNullOrEmpty(newTransfer.Barcode) ||
        newTransfer.Product == null ||
        newTransfer.TransferQuantity <= 0)

        {
            return;
        }

        int quantity = -newTransfer.TransferQuantity;
        decimal totalAmount = -newTransfer.TotalAmount;
        switch (newTransfer.TransferType)
        {
            case StockTransferType.StockIn:
                quantity = newTransfer.TransferQuantity;
                totalAmount = newTransfer.TotalAmount;
                break;
        }


        // Add to pending transfers
        pendingTransfers.Add(new StockTransaction
        {
            Product = newTransfer.Product,
            ProductId = newTransfer.Product.Product_ID,
            Quantity = quantity,
            TotalAmount = totalAmount,
            StockTransactionType = newTransfer.TransferType,
            DayLogId = UserSessionService.CurrentDayLog?.DayLog_Id ?? 1,
            Shift_Id = UserSessionService.CurrentShift?.Shift_Id,
            Created_By_Id = UserSessionService.CurrentUser?.User_ID,
            Last_Modified_By_Id = UserSessionService.CurrentUser?.User_ID,
            Till_Id = UserSessionService.CurrentTill?.Till_Id,
            DateCreated = DateTime.UtcNow,
            LastModified = DateTime.UtcNow,
            TransactionDate = DateTime.UtcNow
        });

        // Reset form
        newTransfer = new NewTransferModel();

        // Refresh filtered transfers
        if (string.IsNullOrEmpty(searchTerm))
        {
            filteredPendingTransfers = pendingTransfers?.ToList() ?? new List<StockTransaction>();
        }
        else
        {
            var searchLower = searchTerm.ToLower();
            filteredPendingTransfers = pendingTransfers?.Where(t =>
            (t.Product?.Product_Barcode != null && t.Product.Product_Barcode.ToLower().Contains(searchLower)) ||
            (t.Product?.Product_Name != null && t.Product.Product_Name.ToLower().Contains(searchLower))
            ).ToList() ?? new List<StockTransaction>();
        }

        // Close modal
        showNewTransferModal = false;
    }

    private void SaveAndExit()
    {
        throw new NotImplementedException();
    }
}
